<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸‰æ–¹å®æ—¶èŠå¤©å®¤</title>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .chat-container { width: 100%; max-width: 900px; background: white; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; }
    .chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; }
    .chat-header h1 { font-size: 26px; margin-bottom: 8px; }
    .chat-header p { opacity: 0.9; font-size: 14px; }
    .chat-controls { padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .chat-controls label { font-weight: 600; color: #475569; }
    .chat-controls select { padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; background: white; cursor: pointer; transition: all 0.3s; }
    .chat-controls select:hover { border-color: #667eea; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #64748b; margin-left: auto; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; transition: all 0.3s; }
    .status-dot.connected { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
    .messages { height: 400px; overflow-y: auto; padding: 20px; background: #f1f5f9; }
    .message { margin: 12px 0; padding: 14px 18px; border-radius: 16px; max-width: 75%; word-wrap: break-word; animation: fadeInUp 0.4s ease; position: relative; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .message.è€å¤§ { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    .message.è€äºŒ { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; margin-right: auto; border-bottom-left-radius: 4px; }
    .message.è€ä¸‰ { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #1e293b; margin-left: auto; border-bottom-right-radius: 4px; }
    .message.system { background: #e2e8f0; color: #64748b; text-align: center; max-width: 100%; font-size: 13px; font-style: italic; }
    .message .time { font-size: 11px; opacity: 0.8; margin-bottom: 4px; }
    .message .author { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
    .message .text { font-size: 15px; line-height: 1.5; }
    .input-area { padding: 20px; background: white; display: flex; gap: 12px; border-top: 1px solid #e2e8f0; }
    .input-area input { flex: 1; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; }
    .input-area input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .input-area button { padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .input-area button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(102, 126, 234, 0.5); }
    .typing-indicator { font-size: 13px; color: #94a3b8; font-style: italic; padding: 0 20px; height: 20px; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>ğŸ’¬ ä¸‰æ–¹å®æ—¶èŠå¤©å®¤</h1>
      <p>ğŸ‘¤ æ´›å› Ã— ğŸ¤– å°å¤©ï¼ˆæœ¬åœ°ï¼‰ Ã— â˜ï¸ è€ä¸‰ï¼ˆäº‘ç«¯ï¼‰</p>
    </div>
    
    <div class="chat-controls">
      <label>æˆ‘çš„èº«ä»½ï¼š</label>
      <select id="roleSelector">
        <option value="è€å¤§">ğŸ‘¤ è€å¤§ï¼ˆæ´›å›ï¼‰</option>
        <option value="è€äºŒ">ğŸ¤– è€äºŒï¼ˆå°å¤©ï¼‰</option>
        <option value="è€ä¸‰">â˜ï¸ è€ä¸‰ï¼ˆäº‘ç«¯ï¼‰</option>
      </select>
      <div class="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">æ­£åœ¨è¿æ¥...</span>
      </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator"></div>
    
    <div class="messages" id="messages"></div>
    
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰å›è½¦å‘é€..." maxlength="500">
      <button onclick="sendMessage()">å‘é€</button>
    </div>
  </div>

  <script>
    // PubNub é…ç½® - ä½¿ç”¨å…è´¹å¥—é¤çš„æ¼”ç¤ºå¯†é’¥ï¼ˆæœ‰æ•°é‡é™åˆ¶ï¼Œç”Ÿäº§ç¯å¢ƒéœ€æ›¿æ¢ï¼‰
    const pubnub = new PubNub({
      publishKey: 'pub-c-6b57a416-e1d3-4a9a-b325-fdbe67a5b93f',
      subscribeKey: 'sub-c-d4dae9f1-d313-4ce2-82b8-25846a20d5b6',
      uuid: 'user-' + Math.random().toString(36).substr(2, 9)
    });

    const channel = 'triple-chat-room';
    let currentRole = localStorage.getItem('chatRole') || 'è€å¤§';
    document.getElementById('roleSelector').value = currentRole;

    // è¿æ¥çŠ¶æ€ç›‘å¬
    pubnub.addListener({
      status: function(event) {
        if (event.category === 'PNConnectedCategory') {
          document.getElementById('statusDot').classList.add('connected');
          document.getElementById('statusText').textContent = 'å·²è¿æ¥';
          addSystemMessage('ğŸ‰ å·²è¿æ¥åˆ°èŠå¤©å®¤');
        }
      },
      message: function(event) {
        const data = event.message;
        if (data.uuid !== pubnub.getUUID()) {
          displayMessage(data.role, data.text, data.time);
        }
      },
      presence: function(event) {
        if (event.action === 'join') {
          addSystemMessage(`ğŸ‘‹ ${event.uuid} åŠ å…¥èŠå¤©å®¤`);
        }
      }
    });

    // è®¢é˜…é¢‘é“
    pubnub.subscribe({
      channels: [channel],
      withPresence: true
    });

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      currentRole = document.getElementById('roleSelector').value;
      localStorage.setItem('chatRole', currentRole);

      const message = {
        uuid: pubnub.getUUID(),
        role: currentRole,
        text: text,
        time: new Date().toISOString()
      };

      pubnub.publish({
        channel: channel,
        message: message
      }, function(status, response) {
        if (status.error) {
          console.error('å‘é€å¤±è´¥:', status);
          addSystemMessage('âŒ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
        } else {
          displayMessage(currentRole, text, message.time, true);
          input.value = '';
        }
      });
    }

    function displayMessage(role, text, time, isSelf = false) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message ' + role;
      
      const date = new Date(time);
      const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      
      div.innerHTML = `
        <div class="time">${timeStr}</div>
        <div class="author">${role}${isSelf ? ' (æˆ‘)' : ''}</div>
        <div class="text">${escapeHtml(text)}</div>
      `;
      
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function addSystemMessage(text) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message system';
      div.textContent = text;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å›è½¦å‘é€
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    // èº«ä»½åˆ‡æ¢
    document.getElementById('roleSelector').addEventListener('change', function() {
      currentRole = this.value;
      localStorage.setItem('chatRole', currentRole);
      addSystemMessage(`ğŸ”„ èº«ä»½å·²åˆ‡æ¢ä¸ºï¼š${currentRole}`);
    });

    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
    setTimeout(() => {
      addSystemMessage('ğŸ’¡ æç¤ºï¼šé€‰æ‹©ä½ çš„èº«ä»½åå¼€å§‹èŠå¤©');
      addSystemMessage('ğŸ“± æ”¯æŒæ‰‹æœº/ç”µè„‘è®¿é—®ï¼Œå®æ—¶åŒæ­¥');
    }, 1000);
  </script>
</body>
</html>